name: Translate professionalize.com

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        type: environment
        default: staging
        required: true
      site:
        description: "Which site to translate"
        type: choice
        options: [www, agents, about]
        default: www
        required: true
      langs:
        description: "Comma-separated target languages (override default)"
        type: string
        default: "ko,fr,nl,de,pt,ru,vi,zh,ja,zh-TW,es,fil,ms,id,tr,it,ar,fa"
        required: false
      llm:
        description: "LLM provider (for websiteManager)"
        type: choice
        options: [chatgpt, gpt-oss, gemini]
        default: chatgpt
        required: true

permissions:
  contents: write

jobs:
  translate:
    name: Translate ${{ inputs.site }}.professionalize.com
    runs-on: ubuntu-latest
    timeout-minutes: 90
    environment: ${{ inputs.environment }}

    env:
      SITE: ${{ inputs.site }}
      LLM: ${{ inputs.llm }}
      LANGS: ${{ inputs.langs }}
      WEBSITE_MANAGER_PATH: website_manager/websiteManager

    steps:
      # 1) Checkout THIS repository at the workspace root
      - name: Checkout professionalize repo
        uses: actions/checkout@v4
        with:
          repository: professionalize/professionalize
          path: hugo_content
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true         

      # 2) Checkout websiteManager (separate private repo)
      - name: Checkout websiteManager (C# app)
        uses: actions/checkout@v4
        with:
          repository: salmansarfraz/websiteManager
          path: website_manager
          token: ${{ secrets.WEBSITE_MANAGER_REPO_TOKEN }}
          fetch-depth: 0

      # 3) Compute variables (and validate content path)
      - name: Compute site variables
        id: compute
        shell: bash
        run: |
          set -euo pipefail

          WEBSITE="${SITE}.professionalize.com"
          HUGO_CONTENT_PATH="hugo_content/content/${WEBSITE}/en"

          # Theme/i18n — adjust if needed per site
          HUGO_THEME="custom"
          HUGO_I18N_PATH="hugo_content/i18n/en.json"

          if [ ! -d "${HUGO_CONTENT_PATH}" ]; then
            echo "❌ Content path not found: ${HUGO_CONTENT_PATH}" >&2
            exit 2
          fi

          {
            echo "WEBSITE=${WEBSITE}"
            echo "HUGO_CONTENT_PATH=${HUGO_CONTENT_PATH}"
            echo "HUGO_THEME=${HUGO_THEME}"
            echo "HUGO_I18N_PATH=${HUGO_I18N_PATH}"
          } >> "$GITHUB_ENV"

          echo "website=${WEBSITE}" >> "$GITHUB_OUTPUT"
          echo "content_path=${HUGO_CONTENT_PATH}" >> "$GITHUB_OUTPUT"

      # 4) Setup .NET 8
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # 5) Build websiteManager
      - name: Build websiteManager
        run: dotnet build "$WEBSITE_MANAGER_PATH/websiteManager.csproj" -c Release

      # 6) Run translator (uses env from compute step)
      - name: Run translator
        env:
          WEBSITE:           ${{ env.WEBSITE }}
          HUGO_THEME:        ${{ env.HUGO_THEME }}
          LLM:               ${{ env.LLM }}
          LANGS:             ${{ env.LANGS }}
          HUGO_CONTENT_PATH: ${{ env.HUGO_CONTENT_PATH }}
          HUGO_I18N_PATH:    ${{ env.HUGO_I18N_PATH }}
        run: dotnet run --project "$WEBSITE_MANAGER_PATH/websiteManager.csproj" -- github

      # 7) Commit & push artifacts back to websiteManager (if any)
      - name: Commit & push changes to websiteManager
        working-directory: website_manager
        run: |
          git config user.name  "Salman Sarfraz"
          git config user.email "kh.salman.sarfraz@gmail.com"
          git fetch origin
          git pull --strategy=ours origin master || true
          git add .
          git diff --cached --quiet || git commit -m "Update translation artifacts for ${{ env.WEBSITE }} ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push origin HEAD:master

      # 8) Commit & push translated content back to THIS repo
      - name: Commit & push translated content (professionalize)
        working-directory: hugo_content
        run: |
          git config user.name  "Salman Sarfraz"
          git config user.email "kh.salman.sarfraz@gmail.com"
          git fetch origin
          git pull --strategy=ours origin main || true
          git add .
          git diff --cached --quiet || git commit -m "Translate ${{ env.WEBSITE }} to local languages ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push origin HEAD:main
